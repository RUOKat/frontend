pipeline {
    agent any
    
    triggers {
        GenericTrigger(
            genericVariables: [
                // [ìˆ˜ì •] ê¸°ì¡´ 'ref' ëŒ€ì‹  'workflow_run' ë‚´ë¶€ì˜ ë¸Œëœì¹˜ëª…ì„ ê°€ì ¸ì˜¤ë„ë¡ ë³€ê²½
                // (ì´ìœ : Push ì´ë²¤íŠ¸ê°€ ì•„ë‹Œ Workflow Run ì´ë²¤íŠ¸ëŠ” êµ¬ì¡°ê°€ ë‹¤ë¦…ë‹ˆë‹¤.)
                [key: 'BRANCH', value: '$.workflow_run.head_branch'],

                // [ì¶”ê°€] ìƒíƒœ í™•ì¸ ë³€ìˆ˜ (ì‹œì‘ë¨/ì§„í–‰ì¤‘/ì™„ë£Œë¨)
                [key: 'STATUS', value: '$.action'],

                // [ì¶”ê°€] ê²°ê³¼ í™•ì¸ ë³€ìˆ˜ (ì„±ê³µ/ì‹¤íŒ¨)
                [key: 'RESULT', value: '$.workflow_run.conclusion']
            ],
            
            // [ìˆ˜ì •] íŠ¸ë¦¬ê±° ì›ì¸ ì„¤ëª… ë³€ê²½
            causeString: 'Triggered by GitHub Actions Completion (Frontend)',
            
            token: 'frontend-deploy-token', // (ê¸°ì¡´ ìœ ì§€)
            
            printContributedVariables: true,
            printPostContent: true,
            
            // [ìˆ˜ì •] í•„í„°ë§ ëŒ€ìƒ ë³€ìˆ˜ ë³€ê²½ ($ref -> $BRANCH $STATUS $RESULT)
            regexpFilterText: '$BRANCH $STATUS $RESULT',
            
            // [ìˆ˜ì •] í•„í„°ë§ ì¡°ê±´ ë³€ê²½
            // í•´ì„: ë¸Œëœì¹˜ëŠ” 'main' + ìƒíƒœëŠ” 'completed(ì™„ë£Œ)' + ê²°ê³¼ëŠ” 'success(ì„±ê³µ)' ì¼ ë•Œë§Œ ì‹¤í–‰
            regexpFilterExpression: 'main completed success'
        )
    }
    
    environment {
        AWS_REGION = 'ap-northeast-2'
        ECS_CLUSTER = 'ruokat-cluster'
        ECS_SERVICE = 'ruokat-frontend-service'
    }
    stages {
        stage('Verify AWS Identity') {
            steps {
                sh "aws sts get-caller-identity"
            }
        }
        stage('Deploy to ECS') {
            steps {
                script {
                    echo "ğŸš€ Deploying ${ECS_SERVICE} to ${ECS_CLUSTER}..."
                    
                    // ECS ì„œë¹„ìŠ¤ ê°•ì œ ì¬ë°°í¬ (ê¸°ì¡´ ìœ ì§€)
                    // --force-new-deployment ë•ë¶„ì— ìƒˆ ì´ë¯¸ì§€ë¥¼ ë¬´ì¡°ê±´ ë‹¹ê²¨ì˜µë‹ˆë‹¤.
                    sh """
                        aws ecs update-service \
                            --cluster ${ECS_CLUSTER} \
                            --service ${ECS_SERVICE} \
                            --force-new-deployment \
                            --region ${AWS_REGION}
                    """
                    
                    // ë°°í¬ íŠ¸ë¦¬ê±° ì™„ë£Œ (ì•ˆì •í™” ëŒ€ê¸°ëŠ” ìƒëµ - ì‹œê°„ ì˜¤ë˜ ê±¸ë¦¼)
                    echo "ğŸ“‹ Deployment triggered. Check ECS console for status."
                    
                    echo "âœ… Frontend deployment triggered successfully!"
                }
            }
        }
    }
    post {
        failure {
            echo "âŒ Frontend deployment failed!"
        }
    }
}
