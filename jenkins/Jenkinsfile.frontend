pipeline {
    agent any
    
    triggers {
        GenericTrigger(
            genericVariables: [
                // [ìˆ˜ì •] Workflow Run ì´ë²¤íŠ¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
                [key: 'BRANCH', value: '$.workflow_run.head_branch'],
                [key: 'STATUS', value: '$.action'],
                [key: 'RESULT', value: '$.workflow_run.conclusion']
            ],
            
            causeString: 'Triggered by GitHub Actions Completion (Frontend)',
            token: 'frontend-deploy-token',
            
            printContributedVariables: true,
            printPostContent: true,
            
            regexpFilterText: '$BRANCH $STATUS $RESULT',
            // [í•„í„°] main ë¸Œëœì¹˜ + ì™„ë£Œë¨ + ì„±ê³µí•¨
            regexpFilterExpression: 'main completed success'
        )
    }
    
    environment {
        AWS_REGION = 'ap-northeast-2'
        ECS_CLUSTER = 'ruokat-cluster'
        ECS_SERVICE = 'ruokat-frontend-service'
    }
    
    stages {
        // [ì¶”ê°€ëœ ë¶€ë¶„] ë¹Œë“œ ì´ë¦„ ì˜ˆì˜ê²Œ ë°”ê¾¸ê¸° âœ¨
        stage('Init & Build Info') {
            steps {
                script {
                    // 1. ë¡œê·¸ì— ì¶œë ¥
                    echo "ğŸš€ Triggered by Branch: ${BRANCH}"
                    
                    // 2. ì  í‚¨ìŠ¤ ë¹Œë“œ ëª©ë¡ì— ë¸Œëœì¹˜ëª… í‘œì‹œ (ì˜ˆ: #25 - main)
                    currentBuild.displayName = "#${BUILD_NUMBER} - ${BRANCH}"
                    
                    // 3. ì„¤ëª… ì¶”ê°€ (ì˜ˆ: Status: completed / Result: success)
                    currentBuild.description = "Status: ${STATUS} / Result: ${RESULT}"
                }
            }
        }

        stage('Verify AWS Identity') {
            steps {
                sh "aws sts get-caller-identity"
            }
        }
        
        stage('Deploy to ECS') {
            steps {
                script {
                    echo "ğŸš€ Deploying ${ECS_SERVICE} to ${ECS_CLUSTER}..."
                    
                    // ECS ì„œë¹„ìŠ¤ ê°•ì œ ì¬ë°°í¬
                    sh """
                        aws ecs update-service \
                            --cluster ${ECS_CLUSTER} \
                            --service ${ECS_SERVICE} \
                            --force-new-deployment \
                            --region ${AWS_REGION}
                    """
                    
                    echo "ğŸ“‹ Deployment triggered. Check ECS console for status."
                    echo "âœ… Frontend deployment triggered successfully!"
                }
            }
        }
    }
    
    post {
        failure {
            echo "âŒ Frontend deployment failed!"
        }
    }
}
